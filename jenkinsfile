pipeline {
    agent { label 'test-fazil' }
    
    environment {
        APP_NAME = "register-app-build-${BUILD_NUMBER}"
        RELEASE = "1.0.0"
        IMAGE_NAME = "fazilkunju/${APP_NAME}"
        IMAGE_TAG = "latest"
    }

    stages {
        stage("Cleanup Workspace") {
            steps { 
                cleanWs() 
            }
        }

        stage("Checkout from SCM") {
            steps {
                git branch: 'master',
                    credentialsId: 'github',
                    url: 'https://github.com/faasilkunju/faasilkunju.git'
            }
        }

        stage("Setup Environment") {
            steps {
                script {
                    sh '''
                        echo "=== Verifying Tools ==="
                        java -version || echo "Java not available"
                        node --version
                        npm --version
                        podman --version
                        unzip -v || echo "unzip not available"
                    '''
                }
            }
        }

        stage("Install Required Tools") {
            steps {
                sh '''
                    # Install unzip if not available
                    if ! command -v unzip &> /dev/null; then
                        echo "Installing unzip..."
                        yum install -y unzip 2>/dev/null || apt-get update && apt-get install -y unzip
                    fi
                    
                    # Verify unzip installation
                    unzip -v && echo "unzip is available" || echo "unzip installation failed"
                '''
            }
        }

        stage("Install Dependencies") {
            steps { 
                sh 'npm install' 
            }
        }

        stage("Run Tests") {
            steps { 
                sh 'PORT=3001 npm test' 
            }
        }

        stage("SonarQube Analysis"){
            steps {
                script {
                    withSonarQubeEnv(credentialsId: 'Sonarqube') { 
                        sh '''
                            export JAVA_HOME=/usr/lib/jvm/java-21-openjdk
                            export PATH=$JAVA_HOME/bin:$PATH
                            
                            echo "Setting up SonarScanner..."
                            if ! command -v sonar-scanner &> /dev/null; then
                                echo "Installing SonarScanner..."
                                
                                # Download SonarScanner with error handling
                                echo "Downloading SonarScanner..."
                                if wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip; then
                                    echo "âœ“ Download successful"
                                    
                                    # Verify zip file integrity
                                    echo "Verifying zip file..."
                                    if unzip -t sonar-scanner-cli-4.8.0.2856-linux.zip &> /dev/null; then
                                        echo "âœ“ Zip file is valid, extracting..."
                                        unzip -q sonar-scanner-cli-4.8.0.2856-linux.zip -d sonar-scanner
                                        export PATH=$PWD/sonar-scanner/sonar-scanner-4.8.0.2856-linux/bin:$PATH
                                        echo "âœ“ SonarScanner installed successfully"
                                    else
                                        echo "âŒ ERROR: Zip file is corrupted"
                                        echo "Cleaning up corrupted file..."
                                        rm -f sonar-scanner-cli-4.8.0.2856-linux.zip
                                        exit 1
                                    fi
                                else
                                    echo "âŒ ERROR: Failed to download SonarScanner"
                                    exit 1
                                fi
                            else
                                echo "âœ“ SonarScanner is already installed"
                            fi
                            
                            # Verify sonar-scanner is available
                            echo "Verifying sonar-scanner command..."
                            sonar-scanner --version || {
                                echo "âŒ ERROR: sonar-scanner command not working"
                                exit 1
                            }
                            
                            echo "Starting SonarQube analysis..."
                            sonar-scanner \\
                                -Dsonar.projectKey=register-app \\
                                -Dsonar.sources=. \\
                                -Dsonar.host.url=$SONAR_HOST_URL \\
                                -Dsonar.login=$SONAR_AUTH_TOKEN \\
                                -Dsonar.coverage.exclusions=**/node_modules/**,**/tests/** \\
                                -Dsonar.exclusions=**/node_modules/**,**/.*/** \\
                                -Dsonar.projectName="Register App" \\
                                -Dsonar.projectVersion=1.0
                            
                            echo "âœ“ SonarQube analysis completed successfully"
                        '''
                    }
                }	
            }
        }

        stage("Quality Gate"){
            steps {
                script {
                    waitForQualityGate abortPipeline: false, credentialsId: 'Sonarqube'
                }	
            }
        }

        stage("Build & Push Container Image") {
            steps {
                script {
                    echo "ðŸš€ Building and pushing to NEW repository: ${IMAGE_NAME}"
                    
                    withCredentials([usernamePassword(
                        credentialsId: 'docker',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            # Clean cache and auth
                            podman system prune -f
                            rm -f /root/.docker/config.json
                            rm -f /run/user/0/containers/auth.json
                            
                            # Login to Docker Hub
                            podman login -u '$DOCKER_USER' -p '$DOCKER_PASS' docker.io
                            
                            # Build the image with FULL registry path
                            podman build -t docker.io/${IMAGE_NAME}:${IMAGE_TAG} .
                            
                            # Push to the new repository
                            podman push docker.io/${IMAGE_NAME}:${IMAGE_TAG}
                            
                            echo "âœ… Successfully pushed: docker.io/${IMAGE_NAME}:${IMAGE_TAG}"
                            echo "ðŸ“¦ Image available at: https://hub.docker.com/r/fazilkunju/${APP_NAME}"
                        """
                    }
                }
            }
        }

        stage("Verify Push") {
            steps {
                script {
                    echo "ðŸ” Verifying push was successful..."
                    withCredentials([usernamePassword(
                        credentialsId: 'docker',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh '''
                            podman login -u $DOCKER_USER -p $DOCKER_PASS docker.io
                            podman pull docker.io/${IMAGE_NAME}:${IMAGE_TAG}
                            echo "âœ… Verification successful - image can be pulled!"
                        '''
                    }
                }
            }
        }

        stage("Trivy Scan") {
            steps {
                script {
                    sh ('docker run -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image fazilkunju/register-app-pipeline:latest --no-progress --scanners vuln  --exit-code 0 --severity HIGH,CRITICAL --format table')
                }
            }
        }

        stage("Deploy Application") {
            steps {
                script {
                    echo "ðŸš€ Deploying application..."
                    
                    sh """
                        # Stop any existing container
                        podman stop register-app || echo "No existing container to stop"
                        podman rm register-app || echo "No existing container to remove"
                        
                        # Deploy the new version
                        podman run -d -p 3001:3001 -e PORT=3001 --name register-app docker.io/${IMAGE_NAME}:${IMAGE_TAG}
                        
                        # Wait for application to start
                        sleep 10
                        
                        # Test the application
                        curl -f http://localhost:3001/ && echo "âœ… Application deployed successfully!" || echo "âŒ Application deployment failed"
                    """
                }
            }
        }
    }

    post {
        always { 
            script {
                echo "ðŸ§¹ Cleaning up workspace..."
                sh '''
                    echo "Cleaning up temporary files..."
                    rm -rf sonar-scanner* *.zip
                '''
            }
            cleanWs() 
        }
        success { 
            echo "ðŸŽ‰ PIPELINE SUCCESSFUL!" 
            script {
                sh '''
                    echo "ðŸ“¦ Build Artifacts:"
                    echo "Docker Image: docker.io/${IMAGE_NAME}:${IMAGE_TAG}"
                    echo "Docker Hub URL: https://hub.docker.com/r/fazilkunju/${APP_NAME}"
                    echo "Application URL: http://localhost:3001/"
                    echo "Application Status: RUNNING"
                '''
            }
        }
        failure { 
            echo "ðŸ’¥ PIPELINE FAILED!" 
            script {
                sh '''
                    echo "Debug information:"
                    echo "Java version:"
                    java -version 2>&1 || echo "Java not available"
                    echo "Node version:"
                    node --version || echo "Node not available"
                    echo "Current directory:"
                    pwd
                    ls -la
                '''
            }
        }
    }
}
